// vAIst Database Schema
// AI-powered VST3 Plugin Generator

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
}

// ============================================
// User Management (BetterAuth compatible)
// ============================================

model User {
  id              String    @id @default(uuid())
  email           String    @unique
  name            String?
  image           String?
  emailVerified   Boolean   @default(false)

  // AI Preferences
  preferredModel  String    @default("gemini-3-flash-preview")
  encryptedApiKey String?   // AES-256 encrypted user's API key

  // Relations
  accounts        Account[]
  sessions        Session[]
  projects        Project[]

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

model Account {
  id                String  @id @default(uuid())
  userId            String
  accountId         String
  providerId        String
  accessToken       String?
  refreshToken      String?
  accessTokenExpiresAt DateTime?
  refreshTokenExpiresAt DateTime?
  scope             String?
  idToken           String?

  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@unique([providerId, accountId])
}

model Session {
  id           String   @id @default(uuid())
  userId       String
  token        String   @unique
  expiresAt    DateTime
  ipAddress    String?
  userAgent    String?

  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model Verification {
  id         String   @id @default(uuid())
  identifier String
  value      String
  expiresAt  DateTime

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

// ============================================
// Plugin Projects
// ============================================

model Project {
  id            String        @id @default(uuid())
  userId        String

  // User's original prompt
  prompt        String

  // AI-generated plan (JSON)
  // { explanation, parameters, dsp_blocks, architecture }
  approvedPlan  String?

  // Build status
  status        ProjectStatus @default(DRAFT)

  // GitHub integration
  githubRunId   String?       // GitHub Actions run ID
  retryCount    Int           @default(0)

  // Artifact storage
  artifactKey   String?       // R2 key for .vst3 file
  wasmArtifactKey String?     // R2 key for .wasm file (available independently)
  artifactUrl   String?       // Signed download URL (generated on demand)

  // Relations
  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  chatMessages  ChatMessage[]
  buildLogs     BuildLog[]

  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@index([userId])
  @@index([status])
}

enum ProjectStatus {
  DRAFT           // Initial state, user editing prompt
  PLANNING        // AI generating plan
  PLAN_PROPOSED   // Plan ready for user review
  APPROVED        // User approved plan, ready to build
  GENERATING      // Generating C++ code
  PUSHING         // Pushing to GitHub
  BUILDING        // GitHub Actions building
  SUCCESS         // Build completed successfully
  FAILED          // Build failed (may retry)
}

// ============================================
// Chat Messages (Plan Negotiation)
// ============================================

model ChatMessage {
  id        String      @id @default(uuid())
  projectId String

  role      MessageRole
  content   String      // Message text

  // For assistant messages, store structured plan
  planJson  String?     // JSON plan if this is a plan proposal

  project   Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)

  createdAt DateTime    @default(now())

  @@index([projectId])
}

enum MessageRole {
  USER
  ASSISTANT
  SYSTEM
}

// ============================================
// Build Logs (Streamed from GitHub Actions)
// ============================================

model BuildLog {
  id        String   @id @default(uuid())
  projectId String

  // Log entry
  timestamp DateTime @default(now())
  level     LogLevel @default(INFO)
  message   String

  // Optional metadata
  step      String?  // e.g., "cmake", "compile", "link"

  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([projectId, timestamp])
}

enum LogLevel {
  DEBUG
  INFO
  WARN
  ERROR
}
